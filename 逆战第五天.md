# 逆战第五天  

* 接口文档编写  
  * 为了让沟通更加效率   
* flask-restful 接口完成 
* tornado    

## 接口文档 

| 接口名称         | 版本号 | 作者       |
| ---------------- | ------ | ---------- |
| 获取指定用户接口 | v1.0   | 朱道布鲁克 |

### 简介 

为其它应用提供用户验证的接口 

### 接口地址  

> http://www.ctqhaveadream.top/api/users/
>
> http://api.ctqhaveadream.top/users  

### 返回格式 

`json`

###　请求方式

`GET` 

### 请求示例 

> http://v.juhe.cn/sms/send?mobile=手机号码&tpl_id=短信模板ID&tpl_value=%23code%23%3D654654&key=

### 请求参数  

| 名称      | 必填 | 类型   | 说明                                                         |
| --------- | ---- | ------ | ------------------------------------------------------------ |
| mobile    | 是   | string | 接收短信的手机号码                                           |
| tpl_id    | 是   | int    | 短信模板ID，请参考个人中心短信模板设置                       |
| tpl_value | 是   | string | 变量名和变量值对，如：#code#=431515，整串值需要urlencode，比如正确结果为：%23code%23%3d431515。如果你的变量名或者变量值中带有#&=中的任意一个特殊符号，请先分别进行utf-8 urlencode编码后再传递，[详细说明>](http://www.juhe.cn/news/index/id/50) |
| key       | 是   | string | 在个人中心->我的数据,接口名称上方查看                        |
| dtype     | 否   | string | 返回数据的格式,xml或json，默认json                           |

### 返回参数说明：

| 名称       | 类型   | 说明     |
| ---------- | ------ | -------- |
| error_code | int    | 返回码   |
| reason     | string | 返回说明 |



### 返回数据示例 

```python
/****失败示例**/
{
    "reason": "错误的短信模板ID,请通过后台确认!!!",
    "result": [],
    "error_code": 205402
}

/****成功示例**/
{
    "reason": "短信发送成功",
    "result": {
        "count": 1, /*发送数量*/
        "fee": 1, /*扣除条数*/
        "sid": "23d6bc4913614919a823271d820662af" /*短信ID*/
    },
    "error_code": 0 /*发送成功*/
}
```



### 小幺鸡 在线api文档   

> http://www.docway.net/ 支持团队协作的接口文档  







## flask-restful 总结  

### add_argument

1. default 设置默认值  
2. required 是否必须  
3. choices 提供相应的选项 只能在这个范围内选择 
4. help 错误信息   
5. trim 是否前后空格  



### 如果有其他额外的验证要求  

> flask-restful.inputs

1. url  判断是否是 url  不是抛异常
2. regex  使用正则表达式
3. date   将字符串转成datetime.date类型 转换不成功 抛异常 

```python
class RegisterView(Resource):
    def post(self):
        from datetime import date #因为我们验证的要求是
        #2020-02-02
        parser = reqparse.RequestParser()
        parser.add_argument('username',required=True,type=str,help='请输入正确用户名')
        parser.add_argument('password',required=True,type=str,help='密码验证错误')
        parser.add_argument('age',type=int,help='年龄验证错误')
        parser.add_argument('gender',type=str,choices=['male','female','secret'],trim=True)
        parser.add_argument('homepage',type=inputs.url,help='个人中心链接验证错误')
        parser.add_argument('telephone',type=inputs.regex(r'1[3456789]\d{9}'),help='请输入正确的手机号')
        parser.add_argument('birth',type=inputs.date,help='生日字段验证错误')
        args = parser.parse_args()
        print(args)
        return {'username':'kangbazi'}

api.add_resource(RegisterView,'/signup/')
```



### 指定返回值  

> 开发过程中，对于视图函数指定字段用于返回  orm模型或者自定义模型的时候  通过  flask_restful.marshal_with装饰器 ，自动获取相应字段  生成json数据   如果需要自定哪些字段返回哪些不返回，那么需要写一个字典  指示返回的字段及类型 

```
from flask_restful import Resource,Api,marshal_with,fields

bp = Blueprint('article',__name__,url_prefix='/article')
api =Api(bp)

class Article(object):
    def __init__(self,title,content):
        self.title = title
        self.content = content
article = Article(title='只要刷一辆法拉利主播带你去登记',content='只要礼物送的多，主播跟你去拍拖')

class ArticleView(Resource):
    resource_fields = {
        'title':fields.String,
        'content':fields.String,   #这里指定 返回的字段及类型  
        'author':fields.String     #这里的字段 如果没有值 那么也应该返回一个nul回去  
    }
    @marshal_with(resource_fields)   #这个装饰器 自动获取字段 并且返回json 类型 
    def post(self):
        return article


api.add_resource(ArticleView,'/')
```

### 返回结果 

```json
{
    "title": "只要刷一辆法拉利主播带你去登记",
    "content": "只要礼物送的多，主播跟你去拍拖",
    "author": null
}
```



## 复杂结构

```python
class ArticleView(Resource):
    resource_fields = {
        'title':fields.String,
        'content':fields.String,
        'author':fields.Nested({
            'username':fields.String,
            'email':fields.String,
        }), #如果这个下面是一个字典 那么可以使用fields.Nested
        'tags':fields.List(fields.Nested({
            'id':fields.Integer,
            'name':fields.String,
        })), #列表 用List
        'readcount':fields.Integer(default=100)
    }
    @marshal_with(resource_fields)
    def get(self,article_id):
        article = Article.query.get(article_id)
        print(article)
        return article
api.add_resource(ArticleView,'<int:article_id>/')
```



### api返回一个 html页面 

```python
from flask import Blueprint,render_template,make_response
from flask_restful import Resource,Api,marshal_with,fields
from models import Article
user_bp = Blueprint('user',__name__,url_prefix='/users')
api =Api(user_bp)

@api.representation('text/html') #告诉浏览器这是一个页面
def output_html(data,code,headers):
    resp = make_response(data)
    return resp



class UserView(Resource):
    def get(self):
        return render_template('user.html') #直接返回返回的是一个字符串
    #浏览器不解析   想让它解析 就得告诉浏览器这是个html页面
    def post(self):
        return '情人节快乐,放开双手勇敢的干'

api.add_resource(UserView,'/')


```

